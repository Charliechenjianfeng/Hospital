<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>分析数据</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/static/admin/layuimini/lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="/static/admin/layuimini/lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all">
    <link rel="stylesheet" href="/static/admin/layuimini/css/public.css" media="all">
    <meta charset="utf-8"><link rel="icon" href="https://jscdn.com.cn/highcharts/images/favicon.ico">

    <style>
        .icon {
            margin-right: 10px;
            color: #1aa094;
        }
    </style>
</head>
<body>
<div class="layuimini-container" id="app" v-cloak>
    <div class="layuimini-main">
        <div class="layuimini-main layui-top-box">
            <div class="layui-row layui-col-space10">
                <div class="layui-col-md12">
                    <div class="layui-card">
                        <div class="layui-card-header"><i class="fa fa-line-chart icon"></i>报表统计</div>
                        <div class="layui-card-body">
                            <div id="echarts-records" style="width: 45%;min-height:300px;float: left; margin-right: 20px"></div>
                            <div id="month-count" style="width: 45%; min-height: 300px; float: right; margin-left: 20px"></div>
                        </div>
                        <div class="layui-card-header" style="margin-top: 330px">
                            <div class="layui-card-body">
                                <div id="ArticleProduct" style="width: 45%;min-height:300px;float: left; margin-right: 20px"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/admin/layuimini/lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script src="/static/admin/layuimini/js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script src="/static/admin/layuimini/lib/jquery-3.4.1/jquery-3.4.1.min.js"></script>
<script src="/static/admin/my/js/my.js" charset="utf-8"></script>
<script type="text/javascript" src="/static/front/js/vue.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/axios/0.19.2/axios.js"></script>
<script src="https://code.highcharts.com.cn/highcharts/highcharts.js"></script>
<script src="https://code.highcharts.com.cn/highcharts/highcharts-more.js"></script>
<script src="https://code.highcharts.com.cn/highcharts/modules/exporting.js"></script>
<script src="https://code.highcharts.com.cn/highcharts-plugins/highcharts-zh_CN.js"></script>
<script src="https://code.highcharts.com.cn/highcharts/themes/grid-light.js"></script>
<script src="/static/front/js/moment.js"></script>
<script>
    layui.use(['layer', 'miniTab', 'echarts'], function () {
        var $ = layui.jquery,
            layer = layui.layer,
            miniTab = layui.miniTab,
            echarts = layui.echarts;
        const vm = new Vue({
            el: '#app',
            data: {
                inCome: [],
                monthCount:[],
                backViews: [],
                articleCount:[],
            },
            methods: {
                getData: function () {
                    axios({
                        url: '/admin/analysis/analysisData',
                        method: 'GET',
                    }).then((result) => {
                        let data = result.data;
                        this.inCome = data.inCome;
                        this.monthCount = data.monthCount;
                        this.articleCount= data.articleCount;
                        this.$nextTick(function () {
                            this.initChart();
                        })
                    });
                },
                toLocaleDate(value) {
                    return moment(value).format('YYYY年M月D日');
                },
                filterViewData(viewData) {
                    let nameResult = [];
                    let dataResult = [];
                    for (let i in viewData){
                      nameResult.push( viewData[i].doctorName);
                      dataResult.push( viewData[i].total);
                    }
                    return {
                        total: dataResult,
                        name: nameResult,
                    }
                },
                filterMonthCount(viewData){
                    let monthResult =[];
                    let dataResult =[];
                    for (let i in viewData){
                        monthResult.push(viewData[i].months);
                        dataResult.push(viewData[i].total);
                    }
                    return {
                        months: monthResult,
                        total: dataResult,
                    }
                },
                filterArticleCount(viewData){
                    let monthResult =[];
                    let dataResult =[];
                    for (let i in viewData){
                        monthResult.push(viewData[i].name);
                        dataResult.push(viewData[i].articleCount);
                    }
                    return {
                        months: monthResult,
                        total: dataResult,
                    }
                },

                initChart() {
                    let analysis = this.filterViewData(this.inCome);
                    let monthCount = this.filterMonthCount(this.monthCount);
                    let articleCount = this. filterArticleCount(this.articleCount);
                    var echartsRecords = echarts.init(document.getElementById('echarts-records'), 'walden');
                    var echarts1 = echarts.init(document.getElementById('month-count'), 'walden');
                    var optionRecords = {
                        title: {
                            text: '医生门诊收入对比'
                        },
                        tooltip: {},
                        legend: {
                            data:['收入']
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: {
                            data: analysis.name
                        },
                        yAxis: {
                            type: 'value'
                        },
                        series: [{
                            name: '收入',
                            type: 'bar',
                            data: analysis.total
                        }]
                    };
                    var option = {
                        backgroundColor: '#fcfaff',

                        title: {
                            text: '营收',
                            subtext: '每月营收数据',
                            x: 'center'
                        },

                        legend: {
                            // orient 设置布局方式，默认水平布局，可选值：'horizontal'（水平） ¦ 'vertical'（垂直）
                            orient: 'horizontal',
                            // x 设置水平安放位置，默认全图居中，可选值：'center' ¦ 'left' ¦ 'right' ¦ {number}（x坐标，单位px）
                            x: 'left',
                            // y 设置垂直安放位置，默认全图顶端，可选值：'top' ¦ 'bottom' ¦ 'center' ¦ {number}（y坐标，单位px）
                            y: 'top',
                            data: ['预期','实际']
                        },

                        //  图表距边框的距离,可选值：'百分比'¦ {number}（单位px）
                        grid: {
                            top: '16%',   // 等价于 y: '16%'
                            left: '3%',
                            right: '8%',
                            bottom: '3%',
                            containLabel: true
                        },
                        // 提示框
                        tooltip: {
                            trigger: 'axis'
                        },
                        //工具框，可以选择
                        toolbox: {
                            feature: {
                                saveAsImage: {} //下载工具
                            }
                        },
                        xAxis: {
                            name: '月份',
                            type: 'category',
                            axisLine: {
                                lineStyle: {
                                    // 设置x轴颜色
                                    color: '#912CEE'
                                }
                            },
                            // 设置X轴数据旋转倾斜
                            axisLabel: {
                                rotate: 30, // 旋转角度
                                interval: 0  //设置X轴数据间隔几个显示一个，为0表示都显示
                            },
                            // boundaryGap值为false的时候，折线第一个点在y轴上
                            boundaryGap: false,
                            data: monthCount.months
                        },

                        yAxis: {
                            name: '数值',
                            type: 'value',
                            min:0, // 设置y轴刻度的最小值
                            splitNumber:9,  // 设置y轴刻度间隔个数
                            axisLine: {
                                lineStyle: {
                                    // 设置y轴颜色
                                    color: '#87CEFA'
                                }
                            },
                        },

                        series: [
                            {
                                name: '实际',
                                data: monthCount.total,
                                type: 'line',
                                // 设置折线上圆点大小
                                symbolSize:8,
                                itemStyle:{
                                    normal:{
                                        // 拐点上显示数值
                                        label : {
                                            show: true
                                        },
                                        borderColor:'red',  // 拐点边框颜色
                                        lineStyle:{
                                            width:5,  // 设置线宽
                                            type:'dotted'  //'dotted'虚线 'solid'实线
                                        }
                                    }
                                }
                            },
                        ],
                    };

                    var chart = Highcharts.chart('ArticleProduct', {
                        chart: {
                            polar: true,
                            type: 'line'
                        },
                        title: {
                            text: '文章数量',
                            x: -80
                        },
                        pane: {
                            size: '80%'
                        },
                        xAxis: {
                            categories:  articleCount.months,
                            tickmarkPlacement: 'on',
                            lineWidth: 0
                        },
                        yAxis: {
                            gridLineInterpolation: 'polygon',
                            lineWidth: 0,
                            min: 0
                        },
                        tooltip: {
                            shared: true,
                            pointFormat: '<span style="color:{series.color}">{series.name}: <b>{point.y:,.0f}</b><br/>'
                        },
                        legend: {
                            align: 'right',
                            verticalAlign: 'top',
                            y: 70,
                            layout: 'vertical'
                        },
                        series: [{
                            name: '文章数量',
                            data:  articleCount.total,
                            pointPlacement: 'on'
                        }]
                    });
                    echartsRecords.setOption(optionRecords);
                    echarts1.setOption(option);
                    // echarts 窗口缩放自适应
                    window.onresize = function () {
                        echartsRecords.resize();
                        echarts1.resize();
                    }
                }
            },
            created() {
                this.getData();
            },
            filters: {
                dateFormat: function (value) {
                    return moment(value).fromNow();
                }
            },
        });

        miniTab.listen();
    });
</script>
</body>
</html>